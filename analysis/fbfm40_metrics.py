"""
Converting fuel models (FBFM40) to fire behavior metrics (like flame length, rate of spread, etc.) in reference conditions.
"""
import sys
import json
import numpy
import pandas
import rasterio

df_fm = pandas.DataFrame(json.loads('[{"fbfm40":1,"ros_ws10mph_fpm":491.10546107832647,"rx_intensity_kW_m2":177.80398597703808,"res_time_min":0.10971428571428571},{"fbfm40":2,"ros_ws10mph_fpm":203.48047900893104,"rx_intensity_kW_m2":770.0886179865292,"res_time_min":0.1379302056279426},{"fbfm40":3,"ros_ws10mph_fpm":425.79921291235337,"rx_intensity_kW_m2":665.5646928112095,"res_time_min":0.256},{"fbfm40":4,"ros_ws10mph_fpm":456.3585056950752,"rx_intensity_kW_m2":2875.2467062008786,"res_time_min":0.22078636586528197},{"fbfm40":5,"ros_ws10mph_fpm":153.89739519779602,"rx_intensity_kW_m2":678.8669741953732,"res_time_min":0.22818499612124019},{"fbfm40":6,"ros_ws10mph_fpm":123.3292676344611,"rx_intensity_kW_m2":437.59174699200724,"res_time_min":0.2455390273287783},{"fbfm40":7,"ros_ws10mph_fpm":128.75214011972344,"rx_intensity_kW_m2":465.2841489843138,"res_time_min":0.24583849973709135},{"fbfm40":8,"ros_ws10mph_fpm":7.71827644400651,"rx_intensity_kW_m2":209.85809884124896,"res_time_min":0.20329720120828762},{"fbfm40":9,"ros_ws10mph_fpm":40.14225564941187,"rx_intensity_kW_m2":549.0617655950334,"res_time_min":0.15460302097864495},{"fbfm40":10,"ros_ws10mph_fpm":46.34625593731968,"rx_intensity_kW_m2":1376.179788245684,"res_time_min":0.21764611427384198},{"fbfm40":11,"ros_ws10mph_fpm":18.40971278226012,"rx_intensity_kW_m2":513.2196335947764,"res_time_min":0.32495697795882206},{"fbfm40":12,"ros_ws10mph_fpm":40.51722432534907,"rx_intensity_kW_m2":1488.733473628445,"res_time_min":0.3354756859246041},{"fbfm40":13,"ros_ws10mph_fpm":48.978039048884625,"rx_intensity_kW_m2":2225.3297240467127,"res_time_min":0.3313244389821007},{"fbfm40":91,"ros_ws10mph_fpm":0.0,"rx_intensity_kW_m2":0.0,"res_time_min":"Infinity"},{"fbfm40":92,"ros_ws10mph_fpm":0.0,"rx_intensity_kW_m2":0.0,"res_time_min":"Infinity"},{"fbfm40":93,"ros_ws10mph_fpm":0.0,"rx_intensity_kW_m2":0.0,"res_time_min":"Infinity"},{"fbfm40":98,"ros_ws10mph_fpm":0.0,"rx_intensity_kW_m2":0.0,"res_time_min":"Infinity"},{"fbfm40":99,"ros_ws10mph_fpm":0.0,"rx_intensity_kW_m2":0.0,"res_time_min":"Infinity"},{"fbfm40":101,"ros_ws10mph_fpm":14.79737064432105,"rx_intensity_kW_m2":92.05810372438549,"res_time_min":0.1869833729216152},{"fbfm40":102,"ros_ws10mph_fpm":87.92117106667558,"rx_intensity_kW_m2":244.20644224094642,"res_time_min":0.2109844658799876},{"fbfm40":103,"ros_ws10mph_fpm":103.90455140433436,"rx_intensity_kW_m2":308.35500875390966,"res_time_min":0.2977304652845389},{"fbfm40":104,"ros_ws10mph_fpm":177.27325556315452,"rx_intensity_kW_m2":474.61445065308857,"res_time_min":0.21034627185506258},{"fbfm40":105,"ros_ws10mph_fpm":136.59537427832313,"rx_intensity_kW_m2":865.2847251746248,"res_time_min":0.23550285145288313},{"fbfm40":106,"ros_ws10mph_fpm":197.95784828850992,"rx_intensity_kW_m2":1325.3132841854215,"res_time_min":0.19139905731570028},{"fbfm40":107,"ros_ws10mph_fpm":258.37699232225015,"rx_intensity_kW_m2":1666.6406919956714,"res_time_min":0.20936412389186823},{"fbfm40":108,"ros_ws10mph_fpm":227.03488586539862,"rx_intensity_kW_m2":2010.1090619820507,"res_time_min":0.2949352692969466},{"fbfm40":109,"ros_ws10mph_fpm":401.32902353976806,"rx_intensity_kW_m2":3042.0773009564323,"res_time_min":0.2381977178408828},{"fbfm40":121,"ros_ws10mph_fpm":64.71486378087454,"rx_intensity_kW_m2":291.7963094768179,"res_time_min":0.20955665024630543},{"fbfm40":122,"ros_ws10mph_fpm":89.91986930610565,"rx_intensity_kW_m2":476.37700543086584,"res_time_min":0.21012730729142198},{"fbfm40":123,"ros_ws10mph_fpm":130.00347383765885,"rx_intensity_kW_m2":772.0560890756184,"res_time_min":0.23794703036382753},{"fbfm40":124,"ros_ws10mph_fpm":106.48484504422197,"rx_intensity_kW_m2":3378.7099467876023,"res_time_min":0.2354222780667724},{"fbfm40":141,"ros_ws10mph_fpm":3.7788924959316996,"rx_intensity_kW_m2":89.03640809216672,"res_time_min":0.22935677631524715},{"fbfm40":142,"ros_ws10mph_fpm":24.397274864463704,"rx_intensity_kW_m2":1164.84263225473,"res_time_min":0.22971884333771272},{"fbfm40":143,"ros_ws10mph_fpm":12.719115867792906,"rx_intensity_kW_m2":389.0404326910691,"res_time_min":0.27999537634510213},{"fbfm40":144,"ros_ws10mph_fpm":107.08303599924203,"rx_intensity_kW_m2":686.5529867569288,"res_time_min":0.2283338581461741},{"fbfm40":145,"ros_ws10mph_fpm":177.81511077162196,"rx_intensity_kW_m2":1118.7901346194417,"res_time_min":0.30680487360142095},{"fbfm40":146,"ros_ws10mph_fpm":70.11599683523295,"rx_intensity_kW_m2":1052.2342695063694,"res_time_min":0.3355682876830045},{"fbfm40":147,"ros_ws10mph_fpm":114.34864933021883,"rx_intensity_kW_m2":1485.4257820320163,"res_time_min":0.3114386108657176},{"fbfm40":148,"ros_ws10mph_fpm":68.46624154953042,"rx_intensity_kW_m2":1615.1010057465483,"res_time_min":0.276969627885575},{"fbfm40":149,"ros_ws10mph_fpm":126.89879887816151,"rx_intensity_kW_m2":2567.833796489643,"res_time_min":0.278656926629776},{"fbfm40":161,"ros_ws10mph_fpm":10.3330588348844,"rx_intensity_kW_m2":350.80865284909385,"res_time_min":0.2390077658246982},{"fbfm40":162,"ros_ws10mph_fpm":44.95206672554619,"rx_intensity_kW_m2":408.7681840166796,"res_time_min":0.217382350167601},{"fbfm40":163,"ros_ws10mph_fpm":99.11978122136715,"rx_intensity_kW_m2":793.8916444379249,"res_time_min":0.23831709250548191},{"fbfm40":164,"ros_ws10mph_fpm":49.942227989858935,"rx_intensity_kW_m2":1363.3180245951182,"res_time_min":0.17325463628182453},{"fbfm40":165,"ros_ws10mph_fpm":27.4432030244224,"rx_intensity_kW_m2":1768.2676138510153,"res_time_min":0.3138266174914029},{"fbfm40":181,"ros_ws10mph_fpm":1.5916422420211531,"rx_intensity_kW_m2":105.7981562530721,"res_time_min":0.2237534007461343},{"fbfm40":182,"ros_ws10mph_fpm":4.117332340153939,"rx_intensity_kW_m2":155.8281907711614,"res_time_min":0.2125966472313487},{"fbfm40":183,"ros_ws10mph_fpm":5.703647377937049,"rx_intensity_kW_m2":177.7866526305196,"res_time_min":0.2504714934367811},{"fbfm40":184,"ros_ws10mph_fpm":8.730743541576157,"rx_intensity_kW_m2":221.8727946233221,"res_time_min":0.24484799550367067},{"fbfm40":185,"ros_ws10mph_fpm":16.65038420232926,"rx_intensity_kW_m2":354.05272076150237,"res_time_min":0.22412908981846083},{"fbfm40":186,"ros_ws10mph_fpm":23.63826420467111,"rx_intensity_kW_m2":508.84348085366724,"res_time_min":0.19835510292868358},{"fbfm40":187,"ros_ws10mph_fpm":8.87759125497545,"rx_intensity_kW_m2":356.5686416096109,"res_time_min":0.3121571513543511},{"fbfm40":188,"ros_ws10mph_fpm":22.139347184960293,"rx_intensity_kW_m2":726.739679537692,"res_time_min":0.21692336615184582},{"fbfm40":189,"ros_ws10mph_fpm":32.75982876774987,"rx_intensity_kW_m2":1052.4479635442547,"res_time_min":0.22152102232360932},{"fbfm40":201,"ros_ws10mph_fpm":22.931331375546876,"rx_intensity_kW_m2":556.8282234923714,"res_time_min":0.23226397415189165},{"fbfm40":202,"ros_ws10mph_fpm":59.91086228506879,"rx_intensity_kW_m2":1127.0066760463862,"res_time_min":0.2038298116632697},{"fbfm40":203,"ros_ws10mph_fpm":110.51546503449502,"rx_intensity_kW_m2":1553.747921846095,"res_time_min":0.19848542294147123},{"fbfm40":204,"ros_ws10mph_fpm":213.1540890803797,"rx_intensity_kW_m2":1636.8439952093277,"res_time_min":0.20141321485011784},{"fbfm40":211,"ros_ws10mph_fpm":14.79737064432105,"rx_intensity_kW_m2":92.05810372438549,"res_time_min":0.1869833729216152},{"fbfm40":212,"ros_ws10mph_fpm":87.92117106667558,"rx_intensity_kW_m2":244.20644224094642,"res_time_min":0.2109844658799876},{"fbfm40":213,"ros_ws10mph_fpm":103.90455140433436,"rx_intensity_kW_m2":308.35500875390966,"res_time_min":0.2977304652845389},{"fbfm40":214,"ros_ws10mph_fpm":177.27325556315452,"rx_intensity_kW_m2":474.61445065308857,"res_time_min":0.21034627185506258},{"fbfm40":215,"ros_ws10mph_fpm":136.59537427832313,"rx_intensity_kW_m2":865.2847251746248,"res_time_min":0.23550285145288313},{"fbfm40":216,"ros_ws10mph_fpm":197.95784828850992,"rx_intensity_kW_m2":1325.3132841854215,"res_time_min":0.19139905731570028},{"fbfm40":217,"ros_ws10mph_fpm":258.37699232225015,"rx_intensity_kW_m2":1666.6406919956714,"res_time_min":0.20936412389186823},{"fbfm40":218,"ros_ws10mph_fpm":227.03488586539862,"rx_intensity_kW_m2":2010.1090619820507,"res_time_min":0.2949352692969466},{"fbfm40":221,"ros_ws10mph_fpm":64.71486378087454,"rx_intensity_kW_m2":291.7963094768179,"res_time_min":0.20955665024630543},{"fbfm40":222,"ros_ws10mph_fpm":89.91986930610565,"rx_intensity_kW_m2":476.37700543086584,"res_time_min":0.21012730729142198},{"fbfm40":223,"ros_ws10mph_fpm":130.00347383765885,"rx_intensity_kW_m2":772.0560890756184,"res_time_min":0.23794703036382753},{"fbfm40":224,"ros_ws10mph_fpm":106.48484504422197,"rx_intensity_kW_m2":3378.7099467876023,"res_time_min":0.2354222780667724},{"fbfm40":241,"ros_ws10mph_fpm":3.7788924959316996,"rx_intensity_kW_m2":89.03640809216672,"res_time_min":0.22935677631524715},{"fbfm40":242,"ros_ws10mph_fpm":24.397274864463704,"rx_intensity_kW_m2":1164.84263225473,"res_time_min":0.22971884333771272},{"fbfm40":243,"ros_ws10mph_fpm":12.719115867792906,"rx_intensity_kW_m2":389.0404326910691,"res_time_min":0.27999537634510213},{"fbfm40":244,"ros_ws10mph_fpm":107.08303599924203,"rx_intensity_kW_m2":686.5529867569288,"res_time_min":0.2283338581461741},{"fbfm40":245,"ros_ws10mph_fpm":177.81511077162196,"rx_intensity_kW_m2":1118.7901346194417,"res_time_min":0.30680487360142095},{"fbfm40":246,"ros_ws10mph_fpm":70.11599683523295,"rx_intensity_kW_m2":1052.2342695063694,"res_time_min":0.3355682876830045},{"fbfm40":247,"ros_ws10mph_fpm":114.34864933021883,"rx_intensity_kW_m2":1485.4257820320163,"res_time_min":0.3114386108657176},{"fbfm40":248,"ros_ws10mph_fpm":68.46624154953042,"rx_intensity_kW_m2":1615.1010057465483,"res_time_min":0.276969627885575},{"fbfm40":249,"ros_ws10mph_fpm":126.89879887816151,"rx_intensity_kW_m2":2567.833796489643,"res_time_min":0.278656926629776},{"fbfm40":261,"ros_ws10mph_fpm":10.3330588348844,"rx_intensity_kW_m2":350.80865284909385,"res_time_min":0.2390077658246982},{"fbfm40":262,"ros_ws10mph_fpm":44.95206672554619,"rx_intensity_kW_m2":408.7681840166796,"res_time_min":0.217382350167601},{"fbfm40":263,"ros_ws10mph_fpm":99.11978122136715,"rx_intensity_kW_m2":793.8916444379249,"res_time_min":0.23831709250548191},{"fbfm40":265,"ros_ws10mph_fpm":27.4432030244224,"rx_intensity_kW_m2":1768.2676138510153,"res_time_min":0.3138266174914029},{"fbfm40":281,"ros_ws10mph_fpm":1.5916422420211531,"rx_intensity_kW_m2":105.7981562530721,"res_time_min":0.2237534007461343},{"fbfm40":282,"ros_ws10mph_fpm":4.117332340153939,"rx_intensity_kW_m2":155.8281907711614,"res_time_min":0.2125966472313487},{"fbfm40":283,"ros_ws10mph_fpm":5.703647377937049,"rx_intensity_kW_m2":177.7866526305196,"res_time_min":0.2504714934367811},{"fbfm40":284,"ros_ws10mph_fpm":8.730743541576157,"rx_intensity_kW_m2":221.8727946233221,"res_time_min":0.24484799550367067},{"fbfm40":285,"ros_ws10mph_fpm":16.65038420232926,"rx_intensity_kW_m2":354.05272076150237,"res_time_min":0.22412908981846083},{"fbfm40":286,"ros_ws10mph_fpm":23.63826420467111,"rx_intensity_kW_m2":508.84348085366724,"res_time_min":0.19835510292868358},{"fbfm40":287,"ros_ws10mph_fpm":8.87759125497545,"rx_intensity_kW_m2":356.5686416096109,"res_time_min":0.3121571513543511},{"fbfm40":288,"ros_ws10mph_fpm":22.139347184960293,"rx_intensity_kW_m2":726.739679537692,"res_time_min":0.21692336615184582},{"fbfm40":289,"ros_ws10mph_fpm":32.75982876774987,"rx_intensity_kW_m2":1052.4479635442547,"res_time_min":0.22152102232360932},{"fbfm40":301,"ros_ws10mph_fpm":22.931331375546876,"rx_intensity_kW_m2":556.8282234923714,"res_time_min":0.23226397415189165},{"fbfm40":302,"ros_ws10mph_fpm":59.91086228506879,"rx_intensity_kW_m2":1127.0066760463862,"res_time_min":0.2038298116632697},{"fbfm40":303,"ros_ws10mph_fpm":110.51546503449502,"rx_intensity_kW_m2":1553.747921846095,"res_time_min":0.19848542294147123}]'))
df_fm['ros_ws10mph_mpm'] = df_fm.ros_ws10mph_fpm * 0.3048
df_fm['ros_ws10mph_mps'] = df_fm.ros_ws10mph_mpm / 60
df_fm['fli_ws10mph_kW_m'] = df_fm.rx_intensity_kW_m2 * (df_fm.res_time_min.astype(float) * df_fm['ros_ws10mph_mpm'])
df_fm['fl_ws10mph_m'] = 0.07747042253266703 * df_fm['fli_ws10mph_kW_m']**0.46


def available_metrics():
    return {
        colname
        for colname in df_fm.columns
        if colname not in {'fbfm40'}
    }


def fbfm40_to_metric_arr(fbfm40_arr, metric_name:str):
    ret = numpy.zeros_like(fbfm40_arr, dtype=float)
    fm_to_val = {r['fbfm40']: r[metric_name] for r in df_fm.to_dict(orient='records')}
    for k, v in fm_to_val.items():
        ret[fbfm40_arr == k] = v
    return ret


def fbfm40_to_metric_raster(fbfm40_raster: str, metric_name:str, tgt_path:str):
    """
    Converts a raster of FBFM40 to a raster of the requested fire behavior metric.
    """
    if not (metric_name in available_metrics()):
        raise ValueError(f'Invalid metric name: {metric_name}. Available metrics: {available_metrics()}')
    with rasterio.open(fbfm40_raster) as src:
        profile = {**src.profile}
        profile['dtype'] = 'float32'
        fm_arr2d = src.read(1)
        metric_arr2d = fbfm40_to_metric_arr(fm_arr2d, metric_name)
        with rasterio.open(tgt_path, 'w', **profile) as dst:
            dst.write(metric_arr2d, 1)
    return metric_arr2d


def main(args):
    verb = args[0]
    if verb == 'fbfm40_to': # INTRO converts a categorical FBFM40 raster to a raster of fire behavior metrics in reference conditions.
        metric_name = args[1]
        dest_path = args[2]
        fbfm40_to_metric_raster(args[1], metric_name, dest_path)
    else:
        raise ValueError(f'Invalid verb: {verb}')
    
if __name__ == '__main__':
    main(sys.argv[1:])

